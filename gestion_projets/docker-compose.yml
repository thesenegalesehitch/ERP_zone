# =============================================================================
# Docker Compose pour le module de Gestion de Projets
# =============================================================================
# Ce fichier définit les services nécessaires pour exécuter le module
# de gestion de projets en environnement de développement.
#
# Usage:
#   docker-compose up -d
#   docker-compose logs -f projects
#   docker-compose down
# =============================================================================

services:
  # Service principal de l'API
  projects-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: erp-projects-api
    restart: unless-stopped
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://erpuser:erppassword@postgres:5432/erp_projects
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DEBUG=${DEBUG:-false}
      - PROJECT_NAME=ERP Zone Projects
      - PROJECT_VERSION=1.0.0
      - DESCRIPTION=Module de gestion de projets
    volumes:
      - ./app:/app/app
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - erp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Base de données PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: erp-projects-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=erpuser
      - POSTGRES_PASSWORD=erppassword
      - POSTGRES_DB=erp_projects
      - POSTGRES_HOST_AUTH_METHOD=md5
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - erp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U erpuser -d erp_projects"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Service Redis pour le caching
  redis:
    image: redis:7-alpine
    container_name: erp-projects-cache
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - erp-network
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Documentation Swagger UI (accessible séparément)
  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: erp-projects-swagger
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - SWAGGER_JSON=/openapi.json
      - URL=/openapi.json
    volumes:
      - ./openapi.json:/openapi.json:ro
    networks:
      - erp-network
    depends_on:
      - projects-api

networks:
  erp-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local

# Commandes utiles:
# docker-compose up -d --build    # Reconstruire et démarrer
# docker-compose logs -f         # Voir les logs
# docker-compose exec projects-api bash  # Accéder au conteneur
# docker-compose down -v          # Arrêter et supprimer les volumes
